<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Potager</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser-ce@2.10.3/build/phaser.min.js"></script>
  <style>
    #game
    {
      cursor:none;
    }
  </style>
</head>

<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="js/async.min.js"></script>
  <script type="text/javascript" src="js/Phasetips/Phasetips.js"></script>>
  <script src="js/PotaCommon.js"></script>
  <script src="js/PotaGen.js"></script>
  <script src="js/PotaTool.js"></script>
  <script src="js/PotaKnow.js"></script>
  <script src="js/game.js"></script>
  <script type="text/javascript">
  "use strict";

  gameLoaded = function() {
    potaKnow.nextKnowledge();
    let actTasks = ['gerer_potager'];

    potaKnow.register(function(task) {
      drawPred(actTasks)
    });

    let kDrawer = $('#knowledge');
    let graph = potaKnow.knowledges;

    function evaluate(taskname) {
      var task = potaKnow.knowledges[taskname]
      if (task.hasOwnProperty('done') && task.done === true)
        return 100
      if (!task.hasOwnProperty('pred'))
        return 0
      let sum = 0
      for (let p of task.pred)
        sum += evaluate(p) / task.pred.length
      return Math.round(sum)
    }

    function drawPred(pred) {
      actTasks = pred
      kDrawer.html('')
      let ret = $('<button>').text('<<')
      ret.click(function() {
        kDrawer.html('');
        drawTask('gerer_potager')
      })
      kDrawer.append(ret)
      for (let p of pred)
        drawTask(p)
    }

    var drawTask = function(taskname) {
      let task = potaKnow.knowledges[taskname]
      let name = task.name
      let done = evaluate(taskname)
      let butt = $('<div>');
      if (task.hasOwnProperty('pred')) {
        butt = $('<button>');
        butt.click(function() {
          let pred = task.pred
          drawPred(pred)
        })
      }
      butt.text(name + ' ' + done + '%')
      kDrawer.append(butt)
    }

    drawPred(actTasks)
  };

  </script>
  <div id="game"></div>
  <div id="knowledge"></div>
</body>

</html>
